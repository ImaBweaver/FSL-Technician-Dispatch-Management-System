<template>
    <section class="sfs-container">
        <div class="sfs-tab-bar" role="tablist">
            <button
                type="button"
                class={listTabButtonClass}
                data-tab="list"
                onclick={handleTabButtonClick}
                aria-pressed={isListTabActive}
            >
                List
            </button>
            <button
                type="button"
                class={calendarTabButtonClass}
                data-tab="calendar"
                onclick={handleCalendarTabClick}
                onkeydown={handleCalendarTabKeydown}
                aria-pressed={isCalendarTabActive}
            >
                Calendar
            </button>
            <template if:true={isManager}>
                <button
                    type="button"
                    class={managerTabButtonClass}
                    data-tab="manager"
                    onclick={handleTabButtonClick}
                    aria-pressed={isManagerTabActive}
                >
                    Manager Console
                </button>
            </template>
        </div>

        <!-- LIST TAB (default) -->
        <template if:true={isListTabActive}>
                <div class="sfs-header">
                    <h2 class="sfs-title">My Service Appointments</h2>
                    <div class="sfs-header-actions">
                        <button
                            type="button"
                            class="slds-button slds-button_brand sfs-quick-quote-btn"
                            onclick={handleLaunchQuickQuoteFlow}
                        >
                            Quick Quote
                        </button>
                        <lightning-button
                            variant="neutral"
                            label="Collapse All"
                            onclick={handleCollapseAllGroups}
                            disabled={collapseAllDisabled}
                        ></lightning-button>
                        <lightning-button
                            variant="neutral"
                            label="Refresh"
                            onclick={handleRefresh}
                            class="sfs-refresh-btn"
                        ></lightning-button>
                    </div>
                </div>

                <template if:true={isManager}>
                    <div class="sfs-viewing-pill">{viewingAsLabel}</div>
                </template>

                <div class="sfs-list-mode">
                    <div class="sfs-list-mode__picker">
                        <lightning-combobox
                            name="listMode"
                            label="View"
                            value={listMode}
                            options={listModeOptions}
                            class="sfs-view-combobox"
                            onchange={handleListModeChange}
                        ></lightning-combobox>
                    </div>
                    <div class="sfs-list-mode__right">
                        <div class="sfs-list-mode-chips" role="list">
                            <template for:each={listModeChips} for:item="chip">
                                <button
                                    key={chip.value}
                                    type="button"
                                    class={chip.className}
                                    data-mode={chip.value}
                                    onclick={handleListModeChange}
                                    aria-pressed={chip.isActive}
                                    role="listitem"
                                >
                                    {chip.label}
                                </button>
                            </template>
                        </div>
                        <lightning-button
                            variant="neutral"
                            label="Collapse All"
                            onclick={handleCollapseAllGroups}
                            disabled={collapseAllDisabled}
                            class="sfs-collapse-all-btn"
                        ></lightning-button>
                    </div>
                </div>

                <!-- Status filter only shows when My tab is active -->
                <template if:true={isMyMode}>
                    <div class="sfs-my-status-filter">
                        <lightning-combobox
                            name="myStatusFilter"
                            label="Status"
                            value={selectedMyStatus}
                            options={myStatusOptions}
                            onchange={handleMyStatusChange}
                        >
                        </lightning-combobox>
                    </div>
                </template>

                <template if:true={isOffline}>
                    <div class="sfs-offline-banner">
                        <lightning-icon
                            icon-name="utility:offline"
                            size="x-small"
                            class="sfs-offline-icon"
                        ></lightning-icon>
                        <span>This tool only works when you are online.</span>
                    </div>
                </template>

                <template if:true={isLoading}>
                    <div class="sfs-loading">
                        <lightning-spinner alternative-text="Loading appointments"></lightning-spinner>
                    </div>
                </template>

                <template if:false={isLoading}>
                        <template if:true={isTransferMode}>
                            <template if:true={transferRequestCount}>
                                <div class="sfs-list">
                                    <template for:each={transferRequests} for:item="req">
                                        <article key={req.transferRequestId} class="sfs-card sfs-transfer-card">
                                        <div class="sfs-card-header sfs-transfer-header">
                                            <span class="sfs-transfer-pill">Transfer Request</span>
                                            <template if:true={req.requestedByName}>
                                                <span class="sfs-transfer-requester">Requested by {req.requestedByName}</span>
                                            </template>
                                        </div>
                                        <div class="sfs-card-body">
                                            <div class="sfs-line">
                                                <span class="sfs-label">WO #</span>
                                                <span class="sfs-value">
                                                    <template if:true={req.workOrderNumber}>
                                                        {req.workOrderNumber}
                                                    </template>
                                                    <template if:false={req.workOrderNumber}>
                                                        —
                                                    </template>
                                                </span>
                                            </div>

                                            <p class="sfs-line">
                                                <span class="sfs-label">Subject</span>
                                                <span class="sfs-value sfs-value_left">{req.workOrderSubject}</span>
                                            </p>

                                            <p class="sfs-line">
                                                <span class="sfs-label">Account</span>
                                                <span class="sfs-value sfs-value_left">{req.accountName}</span>
                                            </p>

                                            <template if:true={req.fullAddress}>
                                                <p class="sfs-line sfs-line_address">
                                                    <span class="sfs-label">Address</span>
                                                    <span class="sfs-value sfs-value_address">
                                                        {req.fullAddress}
                                                    </span>
                                                </p>
                                            </template>
                                        </div>

                                        <div class="sfs-actions sfs-transfer-actions">
                                            <lightning-button
                                                variant="brand"
                                                label="Accept"
                                                data-id={req.transferRequestId}
                                                onclick={handleAcceptTransferRequest}
                                            ></lightning-button>
                                            <lightning-button
                                                variant="destructive"
                                                label="Reject"
                                                data-id={req.transferRequestId}
                                                onclick={openRejectModal}
                                            ></lightning-button>
                                            </div>
                                        </article>
                                    </template>
                                </div>
                            </template>
                            <template if:false={transferRequestCount}>
                                <div class="sfs-empty">
                                    <p>No transfer requests are waiting for you.</p>
                                </div>
                            </template>

                            <div class="sfs-transfer-subsection">
                                <div class="sfs-transfer-subsection-heading">
                                    <h3 class="sfs-transfer-subsection-title">Pending Requests</h3>
                                    <span class="sfs-transfer-count">
                                        ({submittedTransferRequestCount})
                                    </span>
                                </div>

                                <template if:true={submittedTransferRequestCount}>
                                    <div class="sfs-list">
                                        <template
                                            for:each={submittedTransferRequests}
                                            for:item="req"
                                        >
                                            <article
                                                key={req.transferRequestId}
                                                class="sfs-card sfs-transfer-card"
                                            >
                                                <div class="sfs-card-header sfs-transfer-header">
                                                    <span class="sfs-transfer-pill sfs-transfer-pill_submitted">
                                                        Requested Transfer
                                                    </span>
                                                    <template if:true={req.targetName}>
                                                        <span class="sfs-transfer-requester">
                                                            To {req.targetName}
                                                        </span>
                                                    </template>
                                                </div>

                                                <div class="sfs-card-body">
                                                    <div class="sfs-line">
                                                        <span class="sfs-label">WO #</span>
                                                        <span class="sfs-value">
                                                            <template if:true={req.workOrderNumber}>
                                                                {req.workOrderNumber}
                                                            </template>
                                                            <template if:false={req.workOrderNumber}>
                                                                —
                                                            </template>
                                                        </span>
                                                    </div>

                                                    <p class="sfs-line">
                                                        <span class="sfs-label">Subject</span>
                                                        <span class="sfs-value sfs-value_left">{req.workOrderSubject}</span>
                                                    </p>

                                                    <p class="sfs-line">
                                                        <span class="sfs-label">Account</span>
                                                        <span class="sfs-value sfs-value_left">{req.accountName}</span>
                                                    </p>

                                                    <template if:true={req.fullAddress}>
                                                        <p class="sfs-line sfs-line_address">
                                                            <span class="sfs-label">Address</span>
                                                            <span class="sfs-value sfs-value_address">
                                                                {req.fullAddress}
                                                            </span>
                                                        </p>
                                                    </template>
                                                </div>

                                                <div class="sfs-transfer-status">
                                                    <span class={req.statusClass}>{req.statusLabel}</span>
                                                    <template if:true={req.rejectionReason}>
                                                        <p class="sfs-transfer-status-reason">
                                                            Reason: {req.rejectionReason}
                                                        </p>
                                                    </template>
                                                </div>
                                            </article>
                                        </template>
                                    </div>
                                </template>
                                <template if:false={submittedTransferRequestCount}>
                                    <div class="sfs-empty">
                                        <p>You have not sent any transfer requests yet.</p>
                                    </div>
                                </template>
                            </div>
                        </template>

                    <template if:false={isTransferMode}>
                        <template if:true={hasVisibleAppointments}>
                            <div class="sfs-list">
                                <template for:each={appointmentGroups} for:item="group">
                                    <div key={group.key} class="sfs-list-group">
                                        <div class="sfs-list-group__header">
                                            <div class="sfs-list-group__title">
                                                <span class="sfs-list-group__label">{group.label}</span>
                                                <span class="sfs-list-group__count">({group.count})</span>
                                            </div>
                                            <button
                                                type="button"
                                                class="sfs-list-group__toggle"
                                                data-group-key={group.key}
                                                onclick={handleToggleGroup}
                                            >
                                                <lightning-icon
                                                    icon-name={group.toggleIcon}
                                                    size="x-small"
                                                    alternative-text={group.toggleLabel}
                                                    class="sfs-list-group__toggle-icon"
                                                ></lightning-icon>
                                                <span>{group.toggleLabel}</span>
                                            </button>
                                        </div>

                                        <template if:false={group.isCollapsed}>
                                            <div class="sfs-list-group__cards">
                                                <template for:each={group.appointments} for:item="appt">
                                                    <article
                                                        key={appt.cardId}
                                                        class={appt.cardClass}
                                                        data-card-id={appt.cardId}
                                                    >
                                        <div class="sfs-card-header">
                                            <div class="sfs-card-header-pills">
                                                <span class={appt.workTypeClass}>
                                                    {appt.workTypeName}
                                                </span>

                                                <template if:true={appt.opportunityRecordType}>
                                                    <span class="sfs-opportunity-pill">
                                                        {appt.opportunityRecordType}
                                                    </span>
                                                </template>

                                                <template if:true={appt.makeModel}>
                                                    <span class="sfs-makemodel-pill">
                                                        {appt.makeModel}
                                                    </span>
                                                </template>
                                            </div>

                                            <lightning-button-menu
                                                alternative-text="More actions"
                                                icon-name="utility:rows"
                                                onselect={handleMoreActionsSelect}
                                                class="sfs-more-actions-menu sfs-card-header-more-actions"
                                                menu-alignment="right"
                                                data-woid={appt.workOrderId}
                                                data-id={appt.appointmentId}
                                            >
                                                <template if:true={appt.hasAppointment}>
                                                    <lightning-menu-item
                                                        value="unassign"
                                                        label="Unschedule"
                                                    ></lightning-menu-item>
                                                </template>
                                                <lightning-menu-item
                                                    value="requestTransfer"
                                                    label="Request transfer to new technician"
                                                ></lightning-menu-item>
                                                <lightning-menu-item
                                                    value="cancelWorkOrder"
                                                    label="Cancel work order"
                                                ></lightning-menu-item>
                                            </lightning-button-menu>
                                        </div>

                                        <div class="sfs-card-body">
                                            <!-- Subject opens the bottom sheet -->
                                            <div class="sfs-line sfs-wo-line">
                                                <span class="sfs-label">WO #</span>
                                                <span class="sfs-value">
                                                    <template if:true={appt.workOrderNumber}>
                                                        {appt.workOrderNumber}
                                                    </template>
                                                    <template if:false={appt.workOrderNumber}>
                                                        —
                                                    </template>
                                                </span>
                                            </div>

                                            <div class="sfs-subject-row">
                                                <span
                                                    class="sfs-subject-btn sfs-subject-btn_static"
                                                >
                                                    {appt.workOrderSubject}
                                                </span>

                                                <button
                                                    type="button"
                                                    class="sfs-info-button"
                                                    data-id={appt.cardId}
                                                    onclick={handleListInfoClick}
                                                >
                                                    See more info
                                                </button>
                                            </div>

                                            <template if:true={appt.showQuoteActions}>
                                                <div class="sfs-quote-bar">
                                                    <template if:true={appt.quoteAttachmentUrl}>
                                                        <button
                                                            type="button"
                                                            class="sfs-quote-download"
                                                            data-id={appt.cardId}
                                                            onclick={handleQuoteAttachmentClick}
                                                        >
                                                            <lightning-icon
                                                                icon-name="utility:link"
                                                                size="x-small"
                                                                class="sfs-quote-download__icon"
                                                            ></lightning-icon>
                                                            <span class="sfs-quote-download__label">
                                                                Go to files
                                                            </span>
                                                        </button>
                                                    </template>

                                                    <template if:true={appt.showMarkQuoteSentAction}>
                                                        <lightning-button
                                                            variant="brand"
                                                            label="Mark Quote Sent"
                                                            data-woid={appt.workOrderId}
                                                            onclick={handleMarkQuoteSent}
                                                            class="sfs-quote-action-button"
                                                        ></lightning-button>
                                                    </template>
                                                    <template if:true={appt.showMarkPoAttachedAction}>
                                                        <lightning-button
                                                            variant="brand"
                                                            label="Mark PO Attached"
                                                            data-woid={appt.workOrderId}
                                                            onclick={handleMarkPoAttached}
                                                            class="sfs-quote-action-button"
                                                        ></lightning-button>
                                                    </template>
                                                </div>
                                            </template>

                                            <!-- Make / Model row -->
                                            <template if:true={appt.makeModel}>
                                                <p class="sfs-line">
                                                    <span class="sfs-label">Make / Model</span>
                                                    <span class="sfs-value">{appt.makeModel}</span>
                                                </p>
                                            </template>

                                            <!-- Account -->
                                            <p class="sfs-line">
                                                <span class="sfs-label">Account</span>
                                                <span class="sfs-value">{appt.accountName}</span>
                                            </p>

                                            <!-- Address -->
                                            <template if:true={appt.fullAddress}>
                                                <p class="sfs-line sfs-line_address">
                                                    <span class="sfs-label">Address</span>
                                                    <span class="sfs-value sfs-value_address">
                                                        {appt.fullAddress}
                                                    </span>
                                                </p>
                                            </template>

                                            <template if:true={appt.showQuoteLineItems}>
                                                <div class="sfs-quote-lines">
                                                    <button
                                                        type="button"
                                                        class="sfs-quote-lines__toggle"
                                                        data-card-id={appt.cardId}
                                                        onclick={handleToggleQuoteLineItems}
                                                    >
                                                        <lightning-icon
                                                            icon-name={appt.quoteLineItemsExpandedIcon}
                                                            size="x-small"
                                                            class="sfs-quote-lines__toggle-icon"
                                                        ></lightning-icon>
                                                        <span class="sfs-quote-lines__toggle-label">
                                                            {appt.quoteLineItemsToggleLabel}
                                                        </span>
                                                        <span class="sfs-quote-lines__count">
                                                            ({appt.quoteLineItems.length})
                                                        </span>
                                                    </button>

                                                    <template if:true={appt.quoteLineItemsExpanded}>
                                                        <div class="sfs-quote-lines__table-wrapper">
                                                            <table class="sfs-quote-lines__table">
                                                                <thead>
                                                                    <tr>
                                                                        <th scope="col">Part</th>
                                                                        <th scope="col" class="sfs-quote-lines__numeric">
                                                                            Qty
                                                                        </th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    <template for:each={appt.quoteLineItems} for:item="line">
                                                                        <tr key={line.lineItemId}>
                                                                            <td>{line.productName}</td>
                                                                            <td class="sfs-quote-lines__numeric">
                                                                                {line.quantity}
                                                                            </td>
                                                                        </tr>
                                                                    </template>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </template>
                                                </div>
                                            </template>

                                            <!-- Contact (name only) -->
                                            <template if:true={appt.contactName}>
                                                <p class="sfs-line">
                                                    <span class="sfs-label">Contact</span>
                                                    <span class="sfs-value">{appt.contactName}</span>
                                                </p>
                                            </template>

                                            <!-- Expand / collapse toggle -->
                                            <template if:true={appt.hasAppointment}>
                                                <div class="sfs-list-toggle-row">
                                                    <template if:true={appt.isExpanded}>
                                                        <button
                                                            type="button"
                                                            class="sfs-list-toggle-btn sfs-list-toggle-btn_open"
                                                            data-id={appt.appointmentId}
                                                            onclick={handleToggleListDetails}
                                                        >
                                                            <span class="sfs-list-toggle-chevron">▸</span>
                                                            <span>Details</span>
                                                        </button>
                                                    </template>
                                                    <template if:false={appt.isExpanded}>
                                                        <button
                                                            type="button"
                                                            class="sfs-list-toggle-btn"
                                                            data-id={appt.appointmentId}
                                                            onclick={handleToggleListDetails}
                                                        >
                                                            <span class="sfs-list-toggle-chevron">▸</span>
                                                            <span>Details</span>
                                                        </button>
                                                    </template>
                                                </div>
                                            </template>

                                            <!-- Expanded details -->
                                            <template if:true={appt.isExpanded}>
                                                <div class="sfs-list-details">
                                                    <!-- Contact phone -->
                                                    <template if:true={appt.contactPhoneHref}>
                                                        <p class="sfs-list-details-row">
                                                            <span class="sfs-list-details-label">
                                                                Contact Phone
                                                            </span>
                                                            <span class="sfs-list-details-value">
                                                                <a href={appt.contactPhoneHref}>
                                                                    {appt.contactPhone}
                                                                </a>
                                                            </span>
                                                        </p>
                                                    </template>

                                                    <!-- Contact email -->
                                                    <template if:true={appt.contactEmailHref}>
                                                        <p class="sfs-list-details-row">
                                                            <span class="sfs-list-details-label">
                                                                Contact Email
                                                            </span>
                                                            <span class="sfs-list-details-value">
                                                                <a href={appt.contactEmailHref}>
                                                                    {appt.contactEmail}
                                                                </a>
                                                            </span>
                                                        </p>
                                                    </template>

                                                    <!-- Reporter (from Work Order) -->
                                                    <template if:true={appt.reporterContactInfo}>
                                                        <p class="sfs-list-details-row">
                                                            <span class="sfs-list-details-label">
                                                                Reporter
                                                            </span>
                                                            <span class="sfs-list-details-value">
                                                                <template if:true={appt.reporterName}>
                                                                    {appt.reporterName}
                                                                </template>
                                                                <template if:false={appt.reporterName}>
                                                                    {appt.reporterContactInfo}
                                                                </template>
                                                            </span>
                                                        </p>

                                                        <template if:true={appt.reporterPhoneDisplay}>
                                                            <p class="sfs-list-details-row">
                                                                <span class="sfs-list-details-label">
                                                                    Reporter Phone
                                                                </span>
                                                                <span class="sfs-list-details-value">
                                                                    <a href={appt.reporterPhoneHref}>
                                                                        {appt.reporterPhoneDisplay}
                                                                    </a>
                                                                </span>
                                                            </p>
                                                        </template>

                                                        <template if:true={appt.reporterEmail}>
                                                            <p class="sfs-list-details-row">
                                                                <span class="sfs-list-details-label">
                                                                    Reporter Email
                                                                </span>
                                                                <span class="sfs-list-details-value">
                                                                    <a href={appt.reporterEmailHref}>
                                                                        {appt.reporterEmail}
                                                                    </a>
                                                                </span>
                                                            </p>
                                                        </template>
                                                    </template>

                                                    <!-- Schedule summary -->
                                                    <p class="sfs-list-details-row">
                                                        <span class="sfs-list-details-label">
                                                            Start
                                                        </span>
                                                        <span class="sfs-list-details-value">
                                                            <lightning-formatted-date-time
                                                                value={appt.schedStart}
                                                                year="numeric"
                                                                month="short"
                                                                day="2-digit"
                                                                hour="2-digit"
                                                                minute="2-digit"
                                                                time-zone={userTimeZoneId}
                                                            ></lightning-formatted-date-time>
                                                        </span>
                                                    </p>

                                                    <p class="sfs-list-details-row">
                                                        <span class="sfs-list-details-label">
                                                            End
                                                        </span>
                                                        <span class="sfs-list-details-value">
                                                            <lightning-formatted-date-time
                                                                value={appt.schedEnd}
                                                                year="numeric"
                                                                month="short"
                                                                day="2-digit"
                                                                hour="2-digit"
                                                                minute="2-digit"
                                                                time-zone={userTimeZoneId}
                                                            ></lightning-formatted-date-time>
                                                        </span>
                                                    </p>
                                                </div>
                                            </template>

                                            <!-- Start Date/Time display -->
                                            <template if:true={appt.hasAppointment}>
                                                <div class="sfs-input-block sfs-start-display">
                                                    <div class="sfs-start-display__label">
                                                        Start Date/Time
                                                    </div>
                                                    <div class="sfs-start-display__value">
                                                        <lightning-formatted-date-time
                                                            value={appt.schedStart}
                                                            year="numeric"
                                                            month="short"
                                                            day="2-digit"
                                                            hour="2-digit"
                                                            minute="2-digit"
                                                            time-zone={userTimeZoneId}
                                                        ></lightning-formatted-date-time>
                                                    </div>
                                                </div>
                                            </template>

                                            <template if:true={appt.showQuickSchedule}>
                                                <div class="sfs-actions sfs-schedule-actions sfs-quick-schedule__actions-inline sfs-option-actions">
                                                    <lightning-button
                                                        variant="neutral"
                                                        label={appt.quickScheduleLabel}
                                                        data-id={appt.cardId}
                                                        onclick={handleToggleQuickSchedulePanel}
                                                        class="sfs-compact-button sfs-option-button"
                                                    >
                                                    </lightning-button>
                                                    <template if:true={appt.showScheduleOnCalendar}>
                                                        <lightning-button
                                                            variant="brand"
                                                            label="Schedule on Calendar"
                                                            data-id={appt.cardId}
                                                            onclick={handleScheduleOnCalendar}
                                                            class="sfs-compact-button sfs-option-button"
                                                        >
                                                        </lightning-button>
                                                    </template>
                                                </div>

                                                <template if:true={appt.quickScheduleExpanded}>
                                                    <div class="sfs-input-block sfs-quick-schedule__input">
                                                        <lightning-input
                                                            type="datetime-local"
                                                            name="quickScheduleStart"
                                                            label={appt.quickScheduleDateLabel}
                                                            value={appt.quickScheduleStart}
                                                            data-id={appt.cardId}
                                                            onchange={handleQuickScheduleChange}
                                                        >
                                                        </lightning-input>
                                                    </div>

                                                    <div class="sfs-actions sfs-schedule-actions sfs-quick-schedule__footer sfs-option-actions">
                                                        <lightning-button
                                                            variant="brand"
                                                            label={appt.quickScheduleActionLabel}
                                                            data-id={appt.cardId}
                                                            onclick={handleQuickSchedule}
                                                            class="sfs-compact-button sfs-option-button"
                                                        >
                                                        </lightning-button>
                                                    </div>
                                                </template>
                                            </template>

                                            <!-- Crew assignment controls shown only in Crew Pool mode -->
                                            <template if:true={isCrewMode}>
                                                <template if:true={appt.crewOptions}>
                                                    <div class="sfs-input-block">
                                                        <lightning-combobox
                                                            name="crewMember"
                                                            label="Assign to crew member"
                                                            placeholder="Select technician"
                                                            options={appt.crewOptions}
                                                            value={appt.selectedCrewMemberId}
                                                            data-id={appt.appointmentId}
                                                            onchange={handleCrewMemberChange}
                                                        >
                                                        </lightning-combobox>
                                                    </div>

                                                    <div class="sfs-actions">
                                                        <lightning-button
                                                            variant="neutral"
                                                            label="Assign Tech"
                                                            data-id={appt.appointmentId}
                                                            onclick={handleAssignToCrewMember}
                                                            disabled={appt.disableAssignTech}
                                                        >
                                                        </lightning-button>
                                                    </div>
                                                </template>
                                            </template>
                                        </div>
                                    </article>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <template if:false={hasAppointments}>
                            <div class="sfs-empty">
                                <p>No service appointments were found for your resource.</p>
                            </div>
                        </template>
                    </template>
                </template>
        </template>

        <!-- CALENDAR TAB -->
        <template if:true={isCalendarTabActive}>
                <div class="sfs-header sfs-header-calendar">
                    <div class="sfs-calendar-nav">
                        <lightning-button-icon
                            icon-name="utility:chevronleft"
                            alternative-text="Previous"
                            onclick={handleCalendarPrev}
                            class="sfs-calendar-nav-btn"
                        ></lightning-button-icon>
                        <span class="sfs-calendar-range">
                            {calendarRangeLabel}
                        </span>
                        <lightning-button-icon
                            icon-name="utility:chevronright"
                            alternative-text="Next"
                            onclick={handleCalendarNext}
                            class="sfs-calendar-nav-btn"
                        ></lightning-button-icon>
                        <lightning-button
                            variant="base"
                            label="Today"
                            onclick={handleCalendarToday}
                            class="sfs-calendar-today-btn"
                        ></lightning-button>
                    </div>

                    <div class="sfs-calendar-mode-row">
                        <div class="sfs-calendar-mode">
                            <button
                                class={timelineModeClass}
                                type="button"
                                data-mode="timeline"
                                onclick={handleCalendarMode}
                            >
                                Timeline
                            </button>
                            <button
                                class={weekModeClass}
                                type="button"
                                data-mode="week"
                                onclick={handleCalendarMode}
                            >
                                Weeks
                            </button>
                        </div>
                        <template if:false={isDesktopFormFactor}>
                            <button
                                class={calendarPanButtonClass}
                                type="button"
                                aria-pressed={isCalendarPanMode}
                                onclick={handleCalendarPanToggle}
                            >
                                <span class="sfs-calendar-pan-label">Pan calendar</span>
                                <span class="sfs-calendar-pan-state">{calendarPanStateLabel}</span>
                            </button>
                        </template>
                    </div>
                </div>

                <!-- Time zone label -->
                <template if:true={userTimeZoneShort}>
                    <div class="sfs-timezone-label">
                        Times shown in your Salesforce time zone: {userTimeZoneShort}
                    </div>
                </template>

                <template if:true={isManager}>
                    <div class="sfs-viewing-pill">{viewingAsLabel}</div>
                </template>

                <template if:true={isOffline}>
                    <div class="sfs-offline-banner">
                        <lightning-icon
                            icon-name="utility:offline"
                            size="x-small"
                            class="sfs-offline-icon"
                        ></lightning-icon>
                        <span>This tool only works when you are online.</span>
                    </div>
                </template>

                <template if:true={isLoading}>
                    <div class="sfs-loading">
                        <lightning-spinner alternative-text="Loading appointments"></lightning-spinner>
                    </div>
                </template>

                <template if:false={isLoading}>
                    <!-- TIMELINE MODE -->
                    <template if:true={isTimelineMode}>
                        <div class="sfs-calendar">
                            <!-- Global NOW line across the calendar -->
                            <template if:true={showNowLine}>
                                <div
                                    class="sfs-calendar-now-line"
                                    style={nowLineStyle}
                                ></div>
                            </template>

                            <div class="sfs-calendar-hours">
                                <template
                                    for:each={calendarHourLabels}
                                    for:item="hour"
                                >
                                    <div
                                        key={hour}
                                        class="sfs-calendar-hour-label"
                                    >
                                        {hour}
                                    </div>
                                </template>
                            </div>

                            <div class={calendarDaysWrapperClass}>
                                <div
                                    class={calendarDaysClass}
                                    onmousemove={handleCalendarPointerMove}
                                    onmouseup={handleCalendarPointerEnd}
                                    ontouchmove={handleCalendarPointerMove}
                                    ontouchend={handleCalendarPointerEnd}
                                >
                                    <template
                                        for:each={calendarDays}
                                        for:item="day"
                                        for:index="dayIndex"
                                    >
                                        <div
                                            key={day.key}
                                            class={day.cssClassTimeline}
                                            data-day-index={dayIndex}
                                        >
                                            <div class="sfs-calendar-day-header">
                                                {day.fullLabel}
                                            </div>
                                            <div class="sfs-calendar-day-body">
                                                <template
                                                    for:each={day.events}
                                                for:item="evt"
                                            >
                                                <div
                                                    key={evt.key}
                                                    class={evt.className}
                                                    style={evt.style}
                                                    data-id={evt.id}
                                                    data-kind={evt.kind}
                                                    data-day-index={dayIndex}
                                                    onclick={handleEventClick}
                                                    onmousedown={handleEventDragStart}
                                                    ontouchstart={handleEventDragStart}
                                                    onmouseup={handleEventPressEnd}
                                                    ontouchend={handleEventPressEnd}
                                                >
                                                    <!-- RED CREW WARNING BANNER -->
                                                    <template if:true={evt.isCrewAssignment}>
                                                        <div class="sfs-calendar-crew-banner">
                                                            Need Eng Assignment
                                                        </div>
                                                    </template>

                                                    <template if:false={evt.isAbsence}>
                                                        <button
                                                            class="sfs-unassign-btn sfs-unassign-btn_calendar"
                                                            title="Remove me from this work order"
                                                            data-id={evt.id}
                                                            onclick={handleUnassignClick}
                                                            type="button"
                                                        >
                                                            ✕
                                                        </button>
                                                    </template>

                                                    <template if:true={evt.isAbsence}>
                                                        <button
                                                            class="sfs-unassign-btn sfs-unassign-btn_calendar"
                                                            title="Delete absence"
                                                            data-id={evt.id}
                                                            onclick={handleDeleteAbsenceClick}
                                                            type="button"
                                                        >
                                                            ✕
                                                        </button>
                                                    </template>

                                                    <div class="sfs-calendar-event-title">
                                                        {evt.subject}
                                                    </div>

                                                    <template if:true={evt.workOrderNumber}>
                                                        <div class="sfs-calendar-event-wo">
                                                            {evt.workOrderNumber}
                                                        </div>
                                                    </template>

                                                    <div class="sfs-calendar-event-time">
                                                        {evt.timeLabel}
                                                    </div>

                                                    <template if:false={evt.isAbsence}>
                                                        <div
                                                            class="sfs-calendar-event-resize"
                                                            data-id={evt.id}
                                                            data-kind={evt.kind}
                                                            data-day-index={dayIndex}
                                                            onmousedown={handleEventResizeStart}
                                                            ontouchstart={handleEventResizeStart}
                                                        ></div>
                                                    </template>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                                </div>
                            </div>

                            <template if:true={isDragGhostVisible}>
                                <div
                                    class={dragGhostWrapperClass}
                                    style={dragGhostStyle}
                                    onpointerdown={handleGhostPointerDown}
                                >
                                    <div class={dragGhostClass}>
                                        <div class="sfs-calendar-event-title">
                                            {dragGhostTitle}
                                        </div>
                                        <div class="sfs-calendar-event-time">
                                            {dragGhostTime}
                                        </div>
                                    </div>
                                    <template if:true={showDragConfirmActions}>
                                        <div class="sfs-drag-ghost__actions">
                                            <button
                                                class="sfs-drag-ghost__action sfs-drag-ghost__action_confirm"
                                                onclick={confirmPendingSchedule}
                                                aria-label="Confirm schedule placement"
                                            >
                                                ✓
                                            </button>
                                            <button
                                                class="sfs-drag-ghost__action sfs-drag-ghost__action_cancel"
                                                onclick={cancelPendingSchedule}
                                                aria-label="Cancel schedule placement"
                                            >
                                                ✕
                                            </button>
                                        </div>
                                    </template>
                                    <template if:true={dragHelperText}>
                                        <div class="sfs-drag-ghost__hint">{dragHelperText}</div>
                                    </template>
                                </div>
                            </template>

                        </div>
                    </template>

                    <!-- WEEK MODE -->
                    <template if:true={isWeekMode}>
                        <div class="sfs-week-header-row">
                            <template
                                for:each={calendarHeaderDays}
                                for:item="day"
                            >
                                <div key={day.key} class="sfs-week-header-cell">
                                    {day.weekdayLabel}
                                </div>
                            </template>
                        </div>

                        <div class="sfs-weekgrid">
                            <template
                                for:each={calendarWeeks}
                                for:item="week"
                            >
                                <div key={week.key} class="sfs-week-row">
                                    <template
                                        for:each={week.days}
                                        for:item="day"
                                    >
                                        <div key={day.key} class={day.cssClassWeekCell}>
                                            <div class="sfs-week-cell-date">
                                                {day.dayNumberLabel}
                                            </div>
                                            <div class="sfs-week-cell-events">
                                                <template
                                                for:each={day.events}
                                                    for:item="evt"
                                                >
                                                    <div
                                                        key={evt.key}
                                                        class={evt.classNameWeek}
                                                        data-id={evt.id}
                                                        data-kind={evt.kind}
                                                        onclick={handleEventClick}
                                                    >
                                                        <!-- RED CREW WARNING BANNER -->
                                                        <template if:true={evt.isCrewAssignment}>
                                                            <div class="sfs-week-crew-banner">
                                                                Need Eng Assignment
                                                            </div>
                                                        </template>

                                                        <template if:false={evt.isAbsence}>
                                                            <button
                                                                class="sfs-unassign-btn sfs-unassign-btn_calendar"
                                                                title="Remove me from this work order"
                                                                data-id={evt.id}
                                                                onclick={handleUnassignClick}
                                                                type="button"
                                                            >
                                                                ✕
                                                            </button>
                                                        </template>

                                                        <template if:true={evt.isAbsence}>
                                                            <button
                                                                class="sfs-unassign-btn sfs-unassign-btn_calendar"
                                                                title="Delete absence"
                                                                data-id={evt.id}
                                                                onclick={handleDeleteAbsenceClick}
                                                                type="button"
                                                            >
                                                                ✕
                                                            </button>
                                                        </template>

                                                        <template if:true={evt.workOrderNumber}>
                                                            <div class="sfs-week-event-wo">
                                                                {evt.workOrderNumber}
                                                            </div>
                                                        </template>

                                                        <div class="sfs-week-event-time">
                                                            {evt.timeLabel}
                                                        </div>

                                                        <div class="sfs-week-event-title">
                                                            {evt.subject}
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>

                    </template>
                </template>

                <!-- PULL-UP TRAY FOR UNSCHEDULED WORK ORDERS (calendar only) -->
                <template if:true={shouldRenderTray}>
                    <div class={trayContainerClass}>
                        <div class="sfs-tray-handle" onclick={toggleTray}>
                            <div class="sfs-tray-grip"></div>
                            <div class="sfs-tray-title">
                                <div class="sfs-tray-title-main">
                                    {unscheduledLabel}
                                </div>
                                <div class="sfs-tray-title-sub">
                                    <span class="sfs-tray-arrow">▲</span>
                                    Pull up to schedule
                                </div>
                            </div>
                        </div>

                        <template if:true={pullTrayOpen}>
                            <div class="sfs-tray-body">
                                <template if:true={showTrayPeekToggle}>
                                    <div class="sfs-tray-peek-row">
                                        <span class="sfs-tray-peek-text">
                                            {trayPeekHelperText}
                                        </span>
                                        <button
                                            type="button"
                                            class="sfs-tray-peek-toggle"
                                            onclick={handleTrayPeekToggle}
                                        >
                                            {trayPeekToggleLabel}
                                        </button>
                                    </div>
                                </template>
                                <template if:true={showTrayCancelZone}>
                                    <div
                                        class={trayCancelZoneClass}
                                        data-cancel-zone="true"
                                    >
                                        Return here to cancel scheduling
                                    </div>
                                </template>
                                <template if:true={hasUnscheduled}>
                                    <div class="sfs-tray-section">
                                        <div class="sfs-tray-section__header">
                                            <div class="sfs-tray-section__title">
                                                First time schedules
                                            </div>
                                            <span class="sfs-tray-section__count">
                                                ({firstTimeCount})
                                            </span>
                                        </div>

                                        <template if:true={firstTimeCount}>
                                            <template
                                                for:each={firstTimeWorkOrders}
                                                for:item="wo"
                                            >
                                                <article
                                                    key={wo.workOrderId}
                                                    class="sfs-tray-card"
                                                    data-woid={wo.workOrderId}
                                                    ontouchstart={handleTrayCardDragStart}
                                                    onmousedown={handleTrayCardDragStart}
                                                    onclick={handleTrayCardClick}
                                                >
                                                    <div class="sfs-tray-card-header">
                                                        <div class="sfs-tray-card-title">
                                                            <template if:true={wo.workOrderNumber}>
                                                                {wo.workOrderNumber} — {wo.subject}
                                                            </template>
                                                            <template if:false={wo.workOrderNumber}>
                                                                {wo.subject}
                                                            </template>
                                                        </div>

                                                        <lightning-button-icon
                                                            icon-name="utility:info"
                                                            alternative-text="View details"
                                                            variant="bare"
                                                            size="small"
                                                            class="sfs-tray-card-info"
                                                            data-woid={wo.workOrderId}
                                                            onmousedown={handleTrayInfoPointer}
                                                            ontouchstart={handleTrayInfoPointer}
                                                            onclick={handleTrayCardInfoClick}
                                                        ></lightning-button-icon>
                                                    </div>
                                                    <template if:true={wo.isCrewAppointment}>
                                                        <div class="sfs-tray-card-pill">Crew / Queue</div>
                                                    </template>
                                                    <div class="sfs-tray-card-subtitle">
                                                        {wo.accountName}
                                                    </div>
                                                    <div class="sfs-tray-card-status">
                                                        {wo.status}
                                                    </div>
                                                </article>
                                            </template>
                                        </template>
                                        <template if:false={firstTimeCount}>
                                            <p class="sfs-tray-empty">
                                                No first-time schedules need attention.
                                            </p>
                                        </template>
                                    </div>

                                    <div class="sfs-tray-section">
                                        <div class="sfs-tray-section__header">
                                            <div class="sfs-tray-section__title">
                                                Return visit required
                                            </div>
                                            <span class="sfs-tray-section__count">
                                                ({returnVisitCount})
                                            </span>
                                        </div>

                                        <template if:true={returnVisitCount}>
                                            <template
                                                for:each={returnVisitWorkOrders}
                                                for:item="wo"
                                            >
                                                <article
                                                    key={wo.workOrderId}
                                                    class="sfs-tray-card"
                                                    data-woid={wo.workOrderId}
                                                    ontouchstart={handleTrayCardDragStart}
                                                    onmousedown={handleTrayCardDragStart}
                                                    onclick={handleTrayCardClick}
                                                >
                                                    <div class="sfs-tray-card-header">
                                                        <div class="sfs-tray-card-title">
                                                            <template if:true={wo.workOrderNumber}>
                                                                {wo.workOrderNumber} — {wo.subject}
                                                            </template>
                                                            <template if:false={wo.workOrderNumber}>
                                                                {wo.subject}
                                                            </template>
                                                        </div>

                                                        <lightning-button-icon
                                                            icon-name="utility:info"
                                                            alternative-text="View details"
                                                            variant="bare"
                                                            size="small"
                                                            class="sfs-tray-card-info"
                                                            data-woid={wo.workOrderId}
                                                            onmousedown={handleTrayInfoPointer}
                                                            ontouchstart={handleTrayInfoPointer}
                                                            onclick={handleTrayCardInfoClick}
                                                        ></lightning-button-icon>
                                                    </div>
                                                    <template if:true={wo.isCrewAppointment}>
                                                        <div class="sfs-tray-card-pill">Crew / Queue</div>
                                                    </template>
                                                    <div class="sfs-tray-card-subtitle">
                                                        {wo.accountName}
                                                    </div>
                                                    <div class="sfs-tray-card-status">
                                                        {wo.status}
                                                    </div>
                                                </article>
                                            </template>
                                        </template>
                                        <template if:false={returnVisitCount}>
                                            <p class="sfs-tray-empty">
                                                No return visits are waiting to be scheduled.
                                            </p>
                                        </template>
                                    </div>
                                </template>

                                <template if:false={hasUnscheduled}>
                                    <p class="sfs-tray-empty">
                                        No work orders currently need scheduling.
                                    </p>
                                </template>
                            </div>
                        </template>
                    </div>
                </template>
        </template>

        <template if:true={isManagerTabVisible}>
            <div class="sfs-manager-panel">
                <h3 class="sfs-manager-title">Manager console</h3>
                <p class="sfs-manager-copy">
                    Select a team member to view their lists and calendar.
                </p>

                <lightning-combobox
                    name="managerUser"
                    label="Team member"
                    options={managerOptions}
                    value={selectedManagerUserId}
                    onchange={handleManagerUserChange}
                ></lightning-combobox>

                <div class="sfs-actions sfs-manager-actions">
                    <lightning-button
                        variant="brand"
                        label="View as team member"
                        onclick={handleManagerApply}
                        disabled={managerApplyDisabled}
                    ></lightning-button>
                    <lightning-button
                        variant="neutral"
                        label="Return to my view"
                        onclick={handleManagerReset}
                        disabled={managerResetDisabled}
                    ></lightning-button>
                </div>
            </div>
        </template>

        <!-- DETAIL OVERLAY / BOTTOM SHEET -->
        <template if:true={hasSelectedAppointment}>
            <div class="sfs-detail-overlay">
                <article
                    class={detailCardClass}
                >
                    <div class="sfs-detail-header">
                        <div class="sfs-detail-drag-handle"></div>
                        <button
                            class="sfs-detail-close"
                            type="button"
                            onclick={handleCloseDetails}
                        >
                            ✕
                        </button>
                    </div>

                    <h3 class="sfs-detail-title">
                        <button
                            type="button"
                            class="sfs-detail-title-link"
                            onclick={handleOpenWorkOrder}
                        >
                            {selectedAppointment.workOrderSubject}
                        </button>
                        <span class="sfs-detail-title-helper">
                            Click to open this work order in the app
                        </span>
                    </h3>

                    <!-- JOB SECTION -->
                    <div class="sfs-detail-section">
                        <div class="sfs-detail-section-title">Job</div>

                        <p class="sfs-detail-line">
                            <span class="sfs-detail-label">Subject</span>
                            <span class="sfs-detail-value">
                                {selectedAppointment.workOrderSubject}
                            </span>
                        </p>

                    <p class="sfs-detail-line">
                        <span class="sfs-detail-label">WO #</span>
                        <span class="sfs-detail-value">
                            <template if:true={selectedAppointment.workOrderNumber}>
                                {selectedAppointment.workOrderNumber}
                            </template>
                            <template if:false={selectedAppointment.workOrderNumber}>
                                Not set
                            </template>
                        </span>
                    </p>


                        <p class="sfs-detail-line">
                            <span class="sfs-detail-label">Work Type</span>
                            <span class="sfs-detail-value">
                                {selectedAppointment.workTypeName}
                            </span>
                        </p>

                        <template if:true={selectedAppointment.makeModel}>
                            <p class="sfs-detail-line">
                                <span class="sfs-detail-label">Make / Model</span>
                                <span class="sfs-detail-value">
                                    {selectedAppointment.makeModel}
                                </span>
                            </p>
                        </template>

                        <template if:true={selectedAppointment.description}>
                            <p class="sfs-detail-line sfs-detail-line_multiline">
                                <span class="sfs-detail-label">Description</span>
                                <span class="sfs-detail-value sfs-detail-value_multiline">
                                    {selectedAppointment.description}
                                </span>
                            </p>
                        </template>
                    </div>

                    <!-- LOCATION SECTION -->
                    <div class="sfs-detail-section">
                        <div class="sfs-detail-section-title">Location</div>

                        <p class="sfs-detail-line">
                            <span class="sfs-detail-label">Account</span>
                            <span class="sfs-detail-value">
                                <template if:true={selectedAppointment.accountName}>
                                    <button
                                        type="button"
                                        class="sfs-detail-title-link"
                                        onclick={handleOpenAccount}
                                    >
                                        {selectedAppointment.accountName}
                                    </button>
                                </template>
                            </span>
                        </p>

                        <template if:true={selectedAppointment.fullAddress}>
                            <p class="sfs-detail-line sfs-detail-line_multiline">
                                <span class="sfs-detail-label">Address</span>
                                <span class="sfs-detail-value sfs-detail-value_multiline">
                                    {selectedAppointment.fullAddress}
                                </span>
                            </p>
                        </template>
                    </div>

                    <!-- CONTACTS SECTION -->
                    <div class="sfs-detail-section">
                        <div class="sfs-detail-section-title">Contacts</div>

                        <p class="sfs-detail-line">
                            <span class="sfs-detail-label">Contact</span>
                            <span class="sfs-detail-value">
                                <template if:true={selectedAppointment.contactName}>
                                    <button
                                        type="button"
                                        class="sfs-detail-title-link"
                                        onclick={handleOpenContact}
                                    >
                                        {selectedAppointment.contactName}
                                    </button>
                                </template>
                            </span>
                        </p>

                        <template if:true={selectedAppointment.contactPhoneHref}>
                            <p class="sfs-detail-line">
                                <span class="sfs-detail-label">Contact Phone</span>
                                <span class="sfs-detail-value">
                                    <a href={selectedAppointment.contactPhoneHref}>
                                        {selectedAppointment.contactPhone}
                                    </a>
                                </span>
                            </p>
                        </template>

                        <template if:true={selectedAppointment.contactEmailHref}>
                            <p class="sfs-detail-line">
                                <span class="sfs-detail-label">Contact Email</span>
                                <span class="sfs-detail-value">
                                    <a href={selectedAppointment.contactEmailHref}>
                                        {selectedAppointment.contactEmail}
                                    </a>
                                </span>
                            </p>
                        </template>

                        <template if:true={selectedAppointment.reporterContactInfo}>
                            <p class="sfs-detail-line">
                                <span class="sfs-detail-label">Reporter</span>
                                <span class="sfs-detail-value">
                                    <template if:true={selectedAppointment.reporterName}>
                                        {selectedAppointment.reporterName}
                                    </template>
                                    <template if:false={selectedAppointment.reporterName}>
                                        {selectedAppointment.reporterContactInfo}
                                    </template>
                                </span>
                            </p>

                            <template if:true={selectedAppointment.reporterPhoneDisplay}>
                                <p class="sfs-detail-line">
                                    <span class="sfs-detail-label">Reporter Phone</span>
                                    <span class="sfs-detail-value">
                                        <a href={selectedAppointment.reporterPhoneHref}>
                                            {selectedAppointment.reporterPhoneDisplay}
                                        </a>
                                    </span>
                                </p>
                            </template>

                            <template if:true={selectedAppointment.reporterEmail}>
                                <p class="sfs-detail-line">
                                    <span class="sfs-detail-label">Reporter Email</span>
                                    <span class="sfs-detail-value">
                                        <a href={selectedAppointment.reporterEmailHref}>
                                            {selectedAppointment.reporterEmail}
                                        </a>
                                    </span>
                                </p>
                            </template>
                        </template>
                    </div>

                    <!-- SCHEDULE SECTION -->
                    <div class="sfs-detail-section">
                        <div class="sfs-detail-section-title">Schedule</div>

                        <p class="sfs-detail-line">
                            <span class="sfs-detail-label">Start</span>
                            <span class="sfs-detail-value">
                                <lightning-formatted-date-time
                                    value={selectedAppointment.schedStart}
                                    year="numeric"
                                    month="short"
                                    day="2-digit"
                                    hour="2-digit"
                                    minute="2-digit"
                                    time-zone={userTimeZoneId}
                                ></lightning-formatted-date-time>
                            </span>
                        </p>

                        <p class="sfs-detail-line">
                            <span class="sfs-detail-label">End</span>
                            <span class="sfs-detail-value">
                                <lightning-formatted-date-time
                                    value={selectedAppointment.schedEnd}
                                    year="numeric"
                                    month="short"
                                    day="2-digit"
                                    hour="2-digit"
                                    minute="2-digit"
                                    time-zone={userTimeZoneId}
                                ></lightning-formatted-date-time>
                            </span>
                        </p>

                        <!-- Inline reschedule inside detail sheet -->
                        <div class="sfs-detail-reschedule">
                            <p class="sfs-detail-note">
                                Use Quick schedule to change the start date and time.
                            </p>
                            <template if:true={selectedAppointmentCanQuickSchedule}>
                                <lightning-button
                                    variant="brand"
                                    label={selectedQuickScheduleLabel}
                                    onclick={handleOpenQuickScheduleFromDetail}
                                >
                                </lightning-button>
                            </template>
                            <lightning-button-menu
                                alternative-text="More actions"
                                icon-name="utility:rows"
                                onselect={handleMoreActionsSelect}
                                class="sfs-more-actions-menu"
                                menu-alignment="right"
                                data-woid={selectedAppointment.workOrderId}
                                data-id={selectedAppointment.appointmentId}
                            >
                                <lightning-menu-item
                                    value="requestTransfer"
                                    label="Request Reschedule w/ Another Tech"
                                ></lightning-menu-item>
                                <lightning-menu-item
                                    value="cancelWorkOrder"
                                    label="Cancel work order"
                                ></lightning-menu-item>
                            </lightning-button-menu>
                        </div>
                    </div>
                </article>
            </div>
        </template>

        <template if:true={hasSelectedAbsence}>
            <div class="sfs-detail-overlay">
                <article
                    class={absenceDetailCardClass}
                >
                    <div class="sfs-detail-header">
                        <div class="sfs-detail-drag-handle"></div>
                        <button
                            class="sfs-detail-close"
                            type="button"
                            title="Close"
                            onclick={handleCloseAbsenceDetails}
                        >
                            ✕
                        </button>
                    </div>

                    <h3 class="sfs-detail-title">Absence</h3>

                    <div class="sfs-detail-section">
                        <div class="sfs-detail-section-title">Schedule</div>

                        <p class="sfs-detail-line">
                            <span class="sfs-detail-label">Start</span>
                            <span class="sfs-detail-value">
                                <lightning-formatted-date-time
                                    value={selectedAbsence.start}
                                    year="numeric"
                                    month="short"
                                    day="2-digit"
                                    hour="2-digit"
                                    minute="2-digit"
                                    time-zone={userTimeZoneId}
                                ></lightning-formatted-date-time>
                            </span>
                        </p>

                        <p class="sfs-detail-line">
                            <span class="sfs-detail-label">End</span>
                            <span class="sfs-detail-value">
                                <lightning-formatted-date-time
                                    value={selectedAbsence.endTime}
                                    year="numeric"
                                    month="short"
                                    day="2-digit"
                                    hour="2-digit"
                                    minute="2-digit"
                                    time-zone={userTimeZoneId}
                                ></lightning-formatted-date-time>
                            </span>
                        </p>

                        <lightning-input
                            type="datetime-local"
                            name="absenceStartDateTime"
                            label="New Start Date/Time"
                            value={selectedAbsence.newStart}
                            data-field="newStart"
                            onchange={handleAbsenceDateChange}
                        >
                        </lightning-input>

                        <lightning-input
                            type="datetime-local"
                            name="absenceEndDateTime"
                            label="New End Date/Time"
                            value={selectedAbsence.newEnd}
                            data-field="newEnd"
                            onchange={handleAbsenceDateChange}
                        >
                        </lightning-input>

                        <div class="sfs-absence-actions">
                            <lightning-button
                                variant="brand"
                                label="Save Changes"
                                onclick={handleSaveAbsence}
                            ></lightning-button>
                            <lightning-button
                                variant="neutral"
                                label="Close"
                                onclick={handleCloseAbsenceDetails}
                            ></lightning-button>
                        </div>
                    </div>
                </article>
            </div>
        </template>

        <template if:true={isUnassignModalOpen}>
            <div class="sfs-modal-backdrop" onclick={closeUnassignModal}>
                <div class="sfs-modal" onclick={handleDetailCardClick}>
                    <div class="sfs-modal-header">
                        <h3 class="sfs-modal-title">Unschedule</h3>
                        <button
                            class="sfs-modal-close"
                            type="button"
                            onclick={closeUnassignModal}
                        >
                            ✕
                        </button>
                    </div>
                    <p class="sfs-modal-copy">
                        Are you sure you want to unschedule this service appointment?
                    </p>
                    <template if:true={unassignModalSubject}>
                        <p class="sfs-modal-highlight">{unassignModalSubject}</p>
                    </template>
                    <template if:true={unassignModalWorkOrder}>
                        <p class="sfs-modal-subtext">{unassignModalWorkOrder}</p>
                    </template>
                    <div class="sfs-actions sfs-modal-actions">
                        <lightning-button
                            variant="brand"
                            label="Unschedule"
                            onclick={confirmUnassignAppointment}
                            disabled={isLoading}
                        ></lightning-button>
                        <lightning-button
                            variant="neutral"
                            label="Cancel"
                            onclick={closeUnassignModal}
                        ></lightning-button>
                    </div>
                </div>
            </div>
        </template>

        <template if:true={isRescheduleModalOpen}>
            <div class="sfs-modal-backdrop" onclick={closeRescheduleModal}>
                <div class="sfs-modal" onclick={handleDetailCardClick}>
                    <div class="sfs-modal-header">
                        <h3 class="sfs-modal-title">Request transfer</h3>
                        <button
                            class="sfs-modal-close"
                            type="button"
                            onclick={closeRescheduleModal}
                        >
                            ✕
                        </button>
                    </div>
                    <p class="sfs-modal-copy">
                        Choose another technician in the territory to take this work order.
                    </p>
                    <lightning-combobox
                        name="rescheduleTarget"
                        label="Technician"
                        options={rescheduleOptions}
                        value={rescheduleSelection}
                        onchange={handleRescheduleSelection}
                        disabled={rescheduleLoading}
                    ></lightning-combobox>
                    <div class="sfs-actions sfs-modal-actions">
                        <lightning-button
                            variant="brand"
                            label="Send request"
                            onclick={submitRescheduleRequest}
                            disabled={rescheduleSubmitDisabled}
                        ></lightning-button>
                    </div>
                </div>
            </div>
        </template>

        <template if:true={isRejectModalOpen}>
            <div class="sfs-modal-backdrop" onclick={closeRejectModal}>
                <div class="sfs-modal" onclick={handleDetailCardClick}>
                    <div class="sfs-modal-header">
                        <h3 class="sfs-modal-title">Reject transfer request</h3>
                        <button
                            class="sfs-modal-close"
                            type="button"
                            onclick={closeRejectModal}
                        >
                            ✕
                        </button>
                    </div>
                    <p class="sfs-modal-copy">
                        Please provide a reason so the requester understands why the transfer was declined.
                    </p>
                    <lightning-textarea
                        name="rejectReason"
                        label="Rejection reason"
                        value={rejectReason}
                        onchange={handleRejectReasonChange}
                        maxlength="1000"
                    ></lightning-textarea>
                    <div class="sfs-actions sfs-modal-actions">
                        <lightning-button
                            variant="brand"
                            label="Submit rejection"
                            onclick={submitRejectRequest}
                            disabled={rejectSubmitDisabled}
                        ></lightning-button>
                        <lightning-button
                            variant="neutral"
                            label="Cancel"
                            onclick={closeRejectModal}
                        ></lightning-button>
                    </div>
                </div>
            </div>
        </template>

        <template if:true={isCancelModalOpen}>
            <div class="sfs-modal-backdrop" onclick={closeCancelModal}>
                <div class="sfs-modal" onclick={handleDetailCardClick}>
                    <div class="sfs-modal-header">
                        <h3 class="sfs-modal-title">Cancel work order</h3>
                        <button
                            class="sfs-modal-close"
                            type="button"
                            onclick={closeCancelModal}
                        >
                            ✕
                        </button>
                    </div>
                    <p class="sfs-modal-copy">
                        Please provide a reason for canceling this work order. The note will be saved to Tech Support Notes.
                    </p>
                    <lightning-textarea
                        name="cancelReason"
                        label="Cancellation reason"
                        value={cancelReason}
                        onchange={handleCancelReasonChange}
                        maxlength="1000"
                    ></lightning-textarea>
                    <div class="sfs-actions sfs-modal-actions">
                        <lightning-button
                            variant="brand"
                            label="Submit cancellation"
                            onclick={submitCancelWorkOrder}
                            disabled={cancelSubmitDisabled}
                        ></lightning-button>
                        <lightning-button
                            variant="neutral"
                            label="Keep work order"
                            onclick={closeCancelModal}
                        ></lightning-button>
                    </div>
                </div>
            </div>
        </template>
    </section>
</template>
